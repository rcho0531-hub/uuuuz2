from ursina import *
from ursina.prefabs.first_person_controller import FirstPersonController
from ursina.shaders import lit_with_shadows_shader

app = Ursina()
mouse.locked = True

# í–‡ë¹›
sun = DirectionalLight(shadows=True, shadow_map_resolution=(2048,2048))
sun.look_at(Vec3(1,-1,1))
Entity.default_shader = lit_with_shadows_shader
AmbientLight(color=color.rgba(100,100,100,0.5))

# ë°”ë‹¥
GROUND_Y = 0
ground = Entity(
    model='plane',
    scale=60,
    texture='white_cube',
    texture_scale=(60,60),
    collider='box',
    receive_shadows=True
)

# í”Œë ˆì´ì–´
spawn_point = Vec3(0,2,0)
player = FirstPersonController(position=spawn_point, speed=5.5)
player.gravity = 0
player.jump_height = 0
player.collider = BoxCollider(player, Vec3(0,1,0), Vec3(1,2,1))

# ì í”„ / ì¤‘ë ¥
y_velocity = 0
JUMP_FORCE = 9
GRAVITY = 30
TERMINAL_VELOCITY = -50

# ì›…í¬ë¦¬ê¸°
normal_cam_y = 1.8
crouch_cam_y = 1.3
normal_speed = 5.5
crouch_speed = 2.5
player.camera_pivot.y = normal_cam_y

# =========================
# ğŸ”« ë‹¨ìˆœ ì´ ì„¤ì •
# =========================
gun_equipped = False

gun_parent = Entity(
    parent=camera,
    position=Vec3(0.4, -0.3, 0.6),
    rotation=Vec3(0, 0, 0),
    enabled=False
)

# ì´ ëª¸í†µ
gun_body = Entity(
    parent=gun_parent,
    model='cube',
    scale=Vec3(0.3, 0.2, 0.8),
    color=color.dark_gray
)

# ì´ ì†ì¡ì´
gun_handle = Entity(
    parent=gun_parent,
    model='cube',
    scale=Vec3(0.15, 0.35, 0.2),
    position=Vec3(-0.05, -0.35, -0.15),
    rotation=Vec3(0, 0, 10),
    color=color.black
)

# ì´êµ¬
gun_barrel = Entity(
    parent=gun_parent,
    model='cube',
    scale=Vec3(0.1, 0.1, 0.4),
    position=Vec3(0, 0, 0.6),
    color=color.gray
)

# =========================

def update():
    global y_velocity

    # ì¤‘ë ¥
    y_velocity -= GRAVITY * time.dt
    y_velocity = max(y_velocity, TERMINAL_VELOCITY)
    player.y += y_velocity * time.dt

    # ë°”ë‹¥ ì¶©ëŒ
    if player.y <= GROUND_Y:
        player.y = GROUND_Y
        y_velocity = 0

    # ì¶”ë½ ë¦¬ì…‹
    if player.y < -10:
        player.position = spawn_point
        y_velocity = 0

    # ì›…í¬ë¦¬ê¸°
    crouching = held_keys['left shift']
    player.camera_pivot.y = lerp(
        player.camera_pivot.y,
        crouch_cam_y if crouching else normal_cam_y,
        time.dt * 10
    )
    player.speed = crouch_speed if crouching else normal_speed

def input(key):
    global y_velocity, gun_equipped

    if key == 'space' and player.y <= GROUND_Y + 0.01:
        y_velocity = JUMP_FORCE

    # ë§ˆìš°ìŠ¤ ì ê¸ˆ í† ê¸€
    if key == 'tab':
        mouse.locked = not mouse.locked

    # ğŸ”« 1ë²ˆ í‚¤ â†’ ì´ êº¼ë‚´ê¸° / ë„£ê¸°
    if key == '1':
        gun_equipped = not gun_equipped
        gun_parent.enabled = gun_equipped

app.run()
