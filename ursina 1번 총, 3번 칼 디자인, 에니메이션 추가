from ursina import *
from ursina.prefabs.first_person_controller import FirstPersonController
from ursina.shaders import lit_with_shadows_shader
import math

app = Ursina()
mouse.locked = True

# =========================
# í™˜ê²½
# =========================
sun = DirectionalLight(shadows=True, shadow_map_resolution=(2048,2048))
sun.look_at(Vec3(1,-1,1))
Entity.default_shader = lit_with_shadows_shader
AmbientLight(color=color.rgba(100,100,100,0.5))

GROUND_Y = 0
ground = Entity(
    model='plane',
    scale=60,
    texture='white_cube',
    texture_scale=(60,60),
    collider='box',
    receive_shadows=True
)

# =========================
# í”Œë ˆì´ì–´
# =========================
spawn_point = Vec3(0,2,0)
player = FirstPersonController(position=spawn_point, speed=0)
player.gravity = 0
player.jump_height = 0
player.collider = BoxCollider(player, Vec3(0,1,0), Vec3(1,2,1))

# =========================
# ì´ë™ ì„¸íŒ…
# =========================
normal_speed = 5.5
crouch_speed = 2.5

initial_speed = 3.0
ground_accel_time = 0.08
ground_decel_speed = 20

normal_cam_y = 1.8
crouch_cam_y = 1.3
player.camera_pivot.y = normal_cam_y

air_turn_strength = 4.0
air_brake = 8.0
air_max_speed = 9.0

# ì í”„ í›„ ê°€ì† (108%)
jump_bonus_max = 1.08
jump_bonus_ramp = 0.25
jump_bonus_delay = 0.15

jump_bonus = 1.0
jump_delay_timer = 0.0

current_speed = 0
move_velocity = Vec3(0,0,0)

# =========================
# ì í”„ / ì¤‘ë ¥
# =========================
y_velocity = 0
JUMP_FORCE = 9
GRAVITY = 30
TERMINAL_VELOCITY = -50

# =========================
# ë¬´ê¸° ê³µí†µ ìŠ¤í”„ë§ ë³€ìˆ˜
# =========================
gun_bob_timer = 0
gun_jump_offset = 0
gun_jump_velocity = 0

GUN_JUMP_STIFFNESS = 25
GUN_JUMP_DAMPING = 8
GUN_JUMP_PUSH = 0.12

# í™”ë©´ íšŒì „ ìŠ¤ì›¨ì´
last_cam_rot = Vec3(0,0,0)
weapon_rot_sway = Vec3(0,0,0)
ROT_SWAY_STRENGTH = 6.5
ROT_SWAY_DAMPING = 12

# =========================
# ğŸ”« ì´
# =========================
gun_parent = Entity(
    parent=camera,
    position=Vec3(0.4, -0.6, 0.6),
    rotation=Vec3(0,0,0),
    enabled=False
)

gun_base_pos = Vec3(0.4, -0.3, 0.6)
gun_hide_pos = Vec3(0.4, -0.6, 0.6)
gun_base_rot = Vec3(0,0,0)

Entity(parent=gun_parent, model='cube',
       scale=Vec3(0.3,0.2,0.8), color=color.dark_gray)
Entity(parent=gun_parent, model='cube',
       scale=Vec3(0.15,0.35,0.2),
       position=Vec3(-0.05,-0.35,-0.15),
       rotation=Vec3(0,0,10),
       color=color.black)
Entity(parent=gun_parent, model='cube',
       scale=Vec3(0.1,0.1,0.4),
       position=Vec3(0,0,0.6),
       color=color.gray)

# =========================
# ğŸ”ª ì¹¼ (ì˜¤ë¥¸ì†, ì§„ì§œ ì¹¼ í˜•íƒœ)
# =========================
knife_parent = Entity(
    parent=camera,
    position=Vec3(0.45, -0.8, 0.6),   # ì˜¤ë¥¸ì† ìœ„ì¹˜
    rotation=Vec3(0, -20, 0),
    enabled=False
)

knife_base_pos = Vec3(0.45, -0.35, 0.6)
knife_hide_pos = Vec3(0.45, -0.8, 0.6)
knife_base_rot = Vec3(0, -20, 0)

# ì†ì¡ì´
knife_handle = Entity(
    parent=knife_parent,
    model='cube',
    scale=Vec3(0.07, 0.25, 0.07),
    color=color.rgb(60,40,20),
    position=Vec3(0, -0.15, 0)
)

# ê°€ë“œ(ì† ë³´í˜¸ ë¶€ë¶„)
knife_guard = Entity(
    parent=knife_parent,
    model='cube',
    scale=Vec3(0.15, 0.02, 0.08),
    color=color.dark_gray,
    position=Vec3(0, -0.02, 0)
)

# ì¹¼ë‚ (ë©”ì¸)
knife_blade = Entity(
    parent=knife_parent,
    model='cube',
    scale=Vec3(0.05, 0.45, 0.01),
    color=color.light_gray,
    position=Vec3(0, 0.25, 0)
)

# ì¹¼ ëì„ ë¾°ì¡±í•˜ê²Œ ë³´ì´ê²Œ í•˜ëŠ” ë³´ì¡° ë¸”ë¡
knife_tip = Entity(
    parent=knife_parent,
    model='cube',
    scale=Vec3(0.03, 0.08, 0.01),
    color=color.light_gray,
    position=Vec3(0, 0.5, 0)
)

# =========================
# ë¬´ê¸° ìƒíƒœ
# =========================
current_weapon = None   # None / "gun" / "knife"
weapon_anim = 0.0
weapon_anim_speed = 7.0


def update():
    global y_velocity, current_speed, move_velocity
    global jump_bonus, jump_delay_timer
    global gun_bob_timer, gun_jump_offset, gun_jump_velocity
    global last_cam_rot, weapon_rot_sway, weapon_anim

    # ì¤‘ë ¥
    y_velocity -= GRAVITY * time.dt
    y_velocity = max(y_velocity, TERMINAL_VELOCITY)
    player.y += y_velocity * time.dt

    on_ground = False
    if player.y <= GROUND_Y:
        player.y = GROUND_Y
        y_velocity = 0
        on_ground = True
        jump_bonus = 1.0
        jump_delay_timer = 0

    # ì›…í¬ë¦¬ê¸°
    crouching = held_keys['left shift']
    player.camera_pivot.y = lerp(
        player.camera_pivot.y,
        crouch_cam_y if crouching else normal_cam_y,
        time.dt * 10
    )

    # ì´ë™ ì…ë ¥
    direction = Vec3(
        held_keys['d'] - held_keys['a'],
        0,
        held_keys['w'] - held_keys['s']
    )

    if direction.length() > 0:
        direction = camera.forward * direction.z + camera.right * direction.x
        direction.y = 0
        direction = direction.normalized()

    target_speed = crouch_speed if crouching else normal_speed

    # ì§€ìƒ ì´ë™
    if on_ground:
        if direction.length() > 0:
            if current_speed < 0.1:
                current_speed = initial_speed

            accel = time.dt / ground_accel_time
            current_speed = lerp(current_speed, target_speed, accel)
            move_velocity = lerp(move_velocity, direction * current_speed, accel)
        else:
            current_speed = lerp(current_speed, 0, time.dt * ground_decel_speed)
            move_velocity = lerp(move_velocity, Vec3(0,0,0), time.dt * ground_decel_speed)
    else:
        if jump_delay_timer > 0:
            jump_delay_timer -= time.dt
        else:
            jump_bonus = lerp(jump_bonus, jump_bonus_max, time.dt * jump_bonus_ramp)

        if direction.length() > 0 and move_velocity.length() > 0:
            vel_dir = move_velocity.normalized()
            input_dir = direction.normalized()
            dot = vel_dir.dot(input_dir)

            if dot < -0.4:
                move_velocity = lerp(move_velocity, Vec3(0,0,0), time.dt * air_brake)
            else:
                speed = move_velocity.length()
                new_dir = lerp(vel_dir, input_dir, time.dt * air_turn_strength).normalized()
                move_velocity = new_dir * speed

        base_speed = move_velocity.length()
        move_velocity = move_velocity.normalized() * base_speed * jump_bonus

        if move_velocity.length() > air_max_speed:
            move_velocity = move_velocity.normalized() * air_max_speed

    player.position += move_velocity * time.dt

    # =========================
    # ë¬´ê¸° ì„ íƒ
    # =========================
    active_weapon = None
    base_pos = None
    base_rot = None
    hide_pos = None

    if current_weapon == "gun":
        active_weapon = gun_parent
        base_pos = gun_base_pos
        base_rot = gun_base_rot
        hide_pos = gun_hide_pos
    elif current_weapon == "knife":
        active_weapon = knife_parent
        base_pos = knife_base_pos
        base_rot = knife_base_rot
        hide_pos = knife_hide_pos

    if active_weapon:
        weapon_anim = lerp(weapon_anim, 1, time.dt * weapon_anim_speed)
        base = lerp(hide_pos, base_pos, weapon_anim)

        speed_ratio = clamp(move_velocity.length() / normal_speed, 0, 1.5)

        if on_ground and speed_ratio > 0.05:
            gun_bob_timer += time.dt * (6 + speed_ratio * 6)
        else:
            gun_bob_timer += time.dt * 2

        bob_x = math.sin(gun_bob_timer) * 0.01 * speed_ratio
        bob_y = abs(math.cos(gun_bob_timer)) * 0.015 * speed_ratio
        bob_rot = math.sin(gun_bob_timer) * 1.5 * speed_ratio

        # ì í”„ ìŠ¤í”„ë§
        gun_jump_velocity -= gun_jump_offset * GUN_JUMP_STIFFNESS * time.dt
        gun_jump_velocity *= math.exp(-GUN_JUMP_DAMPING * time.dt)
        gun_jump_offset += gun_jump_velocity * time.dt

        # í™”ë©´ íšŒì „ ìŠ¤ì›¨ì´
        cam_rot = camera.rotation
        rot_delta = cam_rot - last_cam_rot
        last_cam_rot = cam_rot

        weapon_rot_sway.x = lerp(weapon_rot_sway.x, -rot_delta.x * ROT_SWAY_STRENGTH, time.dt * ROT_SWAY_DAMPING)
        weapon_rot_sway.y = lerp(weapon_rot_sway.y, -rot_delta.y * ROT_SWAY_STRENGTH, time.dt * ROT_SWAY_DAMPING)

        active_weapon.position = Vec3(
            base.x + bob_x,
            base.y - bob_y + gun_jump_offset,
            base.z
        )

        active_weapon.rotation = Vec3(
            base_rot.x + bob_rot + weapon_rot_sway.x,
            base_rot.y + weapon_rot_sway.y,
            base_rot.z
        )


def input(key):
    global y_velocity, current_weapon, weapon_anim
    global jump_bonus, jump_delay_timer, gun_jump_velocity

    if key == 'space' and player.y <= GROUND_Y + 0.01:
        y_velocity = JUMP_FORCE
        jump_bonus = 1.0
        jump_delay_timer = jump_bonus_delay
        gun_jump_velocity += GUN_JUMP_PUSH

    if key == 'tab':
        mouse.locked = not mouse.locked

    # 1ë²ˆ = ì´
    if key == '1':
        current_weapon = "gun"
        gun_parent.enabled = True
        knife_parent.enabled = False
        weapon_anim = 0

    # 3ë²ˆ = ì¹¼
    if key == '3':
        current_weapon = "knife"
        knife_parent.enabled = True
        gun_parent.enabled = False
        weapon_anim = 0


app.run()
