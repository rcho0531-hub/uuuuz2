from ursina import *
from ursina.prefabs.first_person_controller import FirstPersonController
from ursina.shaders import lit_with_shadows_shader
import random, math

app = Ursina()
mouse.locked = True  # 시작 시 마우스 잠금

# 햇빛
sun = DirectionalLight(shadows=True, shadow_map_resolution=(2048,2048))
sun.look_at(Vec3(1,-1,1))
Entity.default_shader = lit_with_shadows_shader
AmbientLight(color=color.rgba(100,100,100,0.5))

# 바닥
GROUND_Y = 0
ground = Entity(model='plane', scale=60, texture='white_cube',
                texture_scale=(60,60), collider='box', receive_shadows=True)

# 플레이어
spawn_point = Vec3(0,2,0)
player = FirstPersonController(position=spawn_point, speed=5.5)  # 속도 조금 증가
player.gravity = 0
player.jump_height = 0
player.collider = BoxCollider(player, Vec3(0,1,0), Vec3(1,2,1))

# 점프/중력
y_velocity = 0
JUMP_FORCE = 9
GRAVITY = 30
TERMINAL_VELOCITY = -50

# 웅크리기
normal_cam_y = 1.8
crouch_cam_y = 1.3
normal_speed = 5.5
crouch_speed = 2.5
player.camera_pivot.y = normal_cam_y

# Ghost Mode
ghost_mode = False
ghost_speed = 15
last_ghost_pos = player.position

# 맵 범위
MAP_MIN = -15
MAP_MAX = 15

# 적 생성 (주황색 구체)
obstacles = []
for i in range(5):
    obs = Entity(model='sphere', color=color.orange, scale=2,
                 position=Vec3(random.uniform(MAP_MIN, MAP_MAX),
                               random.uniform(1,5),
                               random.uniform(MAP_MIN, MAP_MAX)),
                 collider='box', cast_shadows=True)
    # 랜덤한 속도: 빠르게
    obs.velocity = Vec3(random.uniform(-4,4),
                        random.uniform(0.5,2),  # y 최소값 > 0로 설정
                        random.uniform(-4,4))
    obstacles.append(obs)

# 업데이트
def update():
    global y_velocity, last_ghost_pos

    if not ghost_mode:
        # 점프 & 중력
        y_velocity -= GRAVITY * time.dt
        if y_velocity < TERMINAL_VELOCITY:
            y_velocity = TERMINAL_VELOCITY
        player.y += y_velocity * time.dt

        # 바닥 충돌
        if player.y <= GROUND_Y:
            player.y = GROUND_Y
            y_velocity = 0
        if player.y < -10:
            player.position = spawn_point
            y_velocity = 0

        # 장애물 이동 & 플레이어 밀림
        for obs in obstacles:
            obs.position += obs.velocity * time.dt

            # 바닥보다 낮아지면 올리고 y 속도 반전
            if obs.position.y < 1:
                obs.position.y = 1
                obs.velocity.y = abs(obs.velocity.y)

            # 맵 경계 체크
            for axis in ['x','y','z']:
                val = getattr(obs.position, axis)
                if val < MAP_MIN or val > MAP_MAX:
                    setattr(obs.velocity, axis, -getattr(obs.velocity, axis))
            
            # 플레이어와 충돌 시 x,z만 밀리게
            hit_info = player.intersects(obs)
            if hit_info.hit:
                overlap_vector = (player.position - obs.position).normalized() * 5 * time.dt
                overlap_vector.y = 0
                player.position += overlap_vector

        # 웅크리기
        target_cam_y = crouch_cam_y if held_keys['left shift'] else normal_cam_y
        player.camera_pivot.y = lerp(player.camera_pivot.y, target_cam_y, time.dt*10)
        player.speed = crouch_speed if held_keys['left shift'] else normal_speed

    else:
        # Ghost Mode 자유 이동
        direction = Vec3(
            held_keys['d'] - held_keys['a'],
            held_keys['e'] - held_keys['q'],
            held_keys['w'] - held_keys['s']
        ).normalized()
        player.position += player.forward * direction.z * ghost_speed * time.dt
        player.position += player.right * direction.x * ghost_speed * time.dt
        player.position += Vec3(0,1,0) * direction.y * ghost_speed * time.dt
        last_ghost_pos = player.position

# 입력
def input(key):
    global y_velocity, ghost_mode, last_ghost_pos

    if key == 'space' and not ghost_mode and player.y <= GROUND_Y + 0.01:
        y_velocity = JUMP_FORCE

    # ~ 키로 Ghost Mode 토글
    if key == '`':
        ghost_mode = not ghost_mode
        player.collider.enabled = not ghost_mode
        y_velocity = 0
        if not ghost_mode:
            player.y = max(GROUND_Y, player.y)

    # TAB 키로 마우스 잠금/해제
    if key == 'tab':
        mouse.locked = not mouse.locked

app.run()
