from ursina import *
from ursina.prefabs.first_person_controller import FirstPersonController
from ursina.shaders import lit_with_shadows_shader

app = Ursina()
mouse.locked = True

# 햇빛
sun = DirectionalLight(shadows=True, shadow_map_resolution=(2048,2048))
sun.look_at(Vec3(1,-1,1))
Entity.default_shader = lit_with_shadows_shader
AmbientLight(color=color.rgba(100,100,100,0.5))

# 바닥
GROUND_Y = 0
ground = Entity(
    model='plane',
    scale=60,
    texture='white_cube',
    texture_scale=(60,60),
    collider='box',
    receive_shadows=True
)

# 플레이어
spawn_point = Vec3(0,2,0)
player = FirstPersonController(position=spawn_point, speed=5.5)
player.gravity = 0
player.jump_height = 0
player.collider = BoxCollider(player, Vec3(0,1,0), Vec3(1,2,1))

# 점프 / 중력
y_velocity = 0
JUMP_FORCE = 9
GRAVITY = 30
TERMINAL_VELOCITY = -50

# 웅크리기
normal_cam_y = 1.8
crouch_cam_y = 1.3
normal_speed = 5.5
crouch_speed = 2.5
player.camera_pivot.y = normal_cam_y

def update():
    global y_velocity

    # 중력
    y_velocity -= GRAVITY * time.dt
    y_velocity = max(y_velocity, TERMINAL_VELOCITY)
    player.y += y_velocity * time.dt

    # 바닥 충돌
    if player.y <= GROUND_Y:
        player.y = GROUND_Y
        y_velocity = 0

    # 추락 리셋
    if player.y < -10:
        player.position = spawn_point
        y_velocity = 0

    # 웅크리기
    crouching = held_keys['left shift']
    player.camera_pivot.y = lerp(
        player.camera_pivot.y,
        crouch_cam_y if crouching else normal_cam_y,
        time.dt * 10
    )
    player.speed = crouch_speed if crouching else normal_speed

def input(key):
    global y_velocity

    if key == 'space' and player.y <= GROUND_Y + 0.01:
        y_velocity = JUMP_FORCE

    # 마우스 잠금 토글
    if key == 'tab':
        mouse.locked = not mouse.locked

app.run()
